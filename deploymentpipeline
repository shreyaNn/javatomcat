pipeline {
    agent any
    
    environment {
        NEXUS_URL = "http://nexus:8081"
        NEXUS_REPOSITORY = "maven-snapshots"
        ARTIFACT_GROUP = "com.mycompany.web"
        ARTIFACT_NAME = "app"
        BUILD_VERSION = "2.0-SNAPSHOT"
        EC2_PROD_SERVER = "52.66.248.205"
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Build') {
            steps {
                sh 'mvn clean package'
            }
        }
        
        stage('Pull from Nexus') {
            steps {
                sh """
                    wget ${NEXUS_URL}/repository/${NEXUS_REPOSITORY}/${ARTIFACT_GROUP}/${ARTIFACT_NAME}/${BUILD_VERSION}/${ARTIFACT_NAME}-${BUILD_VERSION}.war -O /tmp/${ARTIFACT_NAME}-${BUILD_VERSION}.war
                """
            }
        }
        
        stage('Deploy to Test Environment') {
            steps {
                sh """
                    docker run -d --name test-container -p 8888:8080 tomcat:9-jre8
                    docker cp /tmp/${ARTIFACT_NAME}-${BUILD_VERSION}.war test-container:/opt/mywarfile/build1.war
                    docker exec test-container /bin/bash -c 'cp /opt/mywarfile/build1.war /usr/local/tomcat/webapps/'
                """
            }
        }
        
        stage('Run Selenium Tests') {
            steps {
                sh '''
                    sleep 30  # Wait for Tomcat to deploy the WAR
                    mvn test -Dtest=SeleniumTest \
                    -Dwebdriver.remote.url=http://selenium-hub:4444/wd/hub \
                    -Dapp.url=http://test-container:8080/build1 \
                    -Dtest.browser=chrome
                '''
            }
        }
        
        stage('Deploy to Production') {
            steps {
                ansiblePlaybook(
                    playbook: 'playbooks/deploy_app.yml',
                    inventory: 'inventory/inventory.ini',
                    extras: "-e \"prod_server=${EC2_PROD_SERVER} build_version=${BUILD_VERSION}\""
                )
            }
        }
    }
    
    post {
        always {
            sh 'docker rm -f test-container || true'
        }
    }
}
