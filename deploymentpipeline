pipeline {
    agent any
    
    environment {
        NEXUS_URL = "http://nexus:8081"
        NEXUS_REPOSITORY = "maven-snapshots"
        ARTIFACT_GROUP = "com.mycompany.web"
        ARTIFACT_NAME = "app"
        BUILD_VERSION = "2.0-SNAPSHOT"
        EC2_PROD_SERVER = "52.66.248.205"
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Build') {
            steps {
                sh 'mvn clean package'
            }
        }
        
        stage('Pull from Nexus') {
            steps {
                sh """
                    wget ${NEXUS_URL}/repository/${NEXUS_REPOSITORY}/${ARTIFACT_GROUP}/${ARTIFACT_NAME}/${BUILD_VERSION}/${ARTIFACT_NAME}-${BUILD_VERSION}.war -O /tmp/${ARTIFACT_NAME}-${BUILD_VERSION}.war
                """
            }
        }
        
        stage('Deploy to Test Environment') {
            steps {
                sh """
                    docker run -d --name test-container ubuntu:latest
                    docker cp /tmp/${ARTIFACT_NAME}-${BUILD_VERSION}.war test-container:/opt/mywarfile/build1.war
                """
            }
        }
        
        stage('Run Selenium Tests') {
            steps {
                // Add your Selenium test execution here
                sh 'echo "Running Selenium tests..."'
                // Example: sh 'mvn test -Dtest=SeleniumTest'
            }
        }
        
        stage('Deploy to Production') {
            steps {
                ansiblePlaybook(
                    playbook: 'playbooks/deploy_app.yml',
                    inventory: 'inventory/inventory.ini',
                    extras: "-e \"prod_server=${EC2_PROD_SERVER} build_version=${BUILD_VERSION}\""
                )
            }
        }
    }
    
    post {
        always {
            sh 'docker rm -f test-container || true'
        }
    }
}
